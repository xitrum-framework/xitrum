Static files
============

.. image:: img/xitrum/be_ti_xitrum_baby_smurf.jpg

Serve static files on disk
--------------------------

Project directory layout:

::

  config
  public
    favicon.ico
    robots.txt
    404.html
    500.html
    img
      myimage.png
    css
      mystyle.css
    js
      myscript.js
  src
  build.sbt

Xitrum automatically serves static files inside ``public`` directory.
URLs to them are in the form:

::

  /img/myimage.png
  /css/mystyle.css

To refer to them:

::

  <img src={urlForPublic("img/myimage.png")} />

To send a static file on disk from your action, use ``respondFile``.

::

  respondFile("/absolute/path")
  respondFile("path/relative/to/the/current/working/directory")

404 and 500
-----------

404.html and 500.html in ``public`` directory are used when there's no matching
route and there's error processing request, respectively. If you want to use
your own handler, configure before starting web server:

::

  import xitrum.Config
  import xitrum.routing.Routes
  import xitrum.handler.Server

  object Boot {
    def main(args: Array[String]) {
      Routes.route404 = MyController.route404
      Routes.route500 = MyController.route500
      Routes.fromCacheFileOrRecollect()
      Server.start()
    }
  }

Response status is set to 404 or 500 before the actions are executed, so you
don't have to set yourself.

Serve resource files in classpath
---------------------------------

If you are a library developer and want to serve myimage.png from your library,
which is a .jar file in classpath:

Save the file in your .jar under ``public`` directory:

::

  public/my_lib/img/myimage.png

To refer to them in your source code:

::

  <img src={urlForResource("my_lib/img/myimage.png")} />

It will become:

::

  <img src="/resources/public/my_lib/img/myimage.png" />

To send a static file inside an element (a .jar file or a directory) in classpath:

::

  respondResource("path/relative/to/the/element")

Client side cache with ETag and max-age
---------------------------------------

Xitrum automatically adds `Etag <http://en.wikipedia.org/wiki/HTTP_ETag>`_ for
static files on disk and in classpath.

ETags for small files are MD5 of file content. They are cached for later use.
Keys of cache entries are ``(file path, modified time)``. Because modified time
on different servers may differ, each web server in a cluster has its own local
ETag cache, not based on Hazelcast.

For big files, only modified time is used as ETag. This is not perfect because not
identical file on different servers may have different ETag, but it is still better
than no ETag at all.

``urlForPublic`` and ``urlForResource`` automatically add ETag to the URLs they
generate. For example:

::

  urlForResource("xitrum/jquery-1.6.4.js")
  => /resources/public/xitrum/jquery-1.6.4.js?xndGJVH0zA8q8ZJJe1Dz9Q

Xitrum also sets ``max-age`` and ``Expires`` header to
`one year <http://code.google.com/intl/en/speed/page-speed/docs/caching.html>`_.
Don't worry that browsers do not pickup a latest file when you change it.
Because when a file on disk changes, its ``modified time`` changes, thus the URLs
generated by ``urlForPublic`` and ``urlForResource`` also change. Its ETag cache
is also updated because the cache key changes.

GZIP
----

Xitrum automatically gzips textual responses. It checks the ``Content-Type``
header to determine if a response is textual: ``text/html``, ``xml/application`` etc.

Xitrum always gzips static textual files, but for dynamic textual responses,
for overall performance reason it does not gzips response smaller than 1 KB.

Server side cache
-----------------

To avoid loading files from disk, Xitrum caches small static files
(not only textual) in memory with LRU (Least Recently Used) expiration.
See ``small_static_file_size_in_kb`` and ``max_cached_small_static_files``
in ``config/xitrum.properties``.

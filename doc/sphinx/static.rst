Static files
============

.. image:: img/xitrum/be_ti_xitrum_baby_smurf.jpg

Serve static files on disk
--------------------------

Project directory layout:

::

  config
  static
    favicon.ico
    robots.txt
    public
      img
        myimage.png
      css
        mystyle.css
  src
  build.sbt

Xitrum automatically serves static files inside ``static/public`` directory.
URLs to them must have prefix ``/public/``:

::

  /public/img/myimage.png
  /public/css/mystyle.css

This design decision is for speed. It avoids disk I/O by not checking for file
existence on every request.

To refer to them:

::

  <img src={urlForPublic("img/myimage.png")} />

To send a static file on disk from your action, use ``renderFile``.

::

  renderFile("/absolute/path")
  renderFile("relative/path/to/the/current/working/directory")

public_files_not_behind_public_url
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

favicon.ico and robots.txt are special files, their URLs do not have ``/public``
prefix:

::

  /favicon.ico
  /robots.txt

When for example you have a file called crossdomain.xml and you want its
URL to be ``http://mydomain.com/crossdomain.xml`` (no ``/public/`` prefix),
modify ``public_files_not_behind_public_url`` in ``config/xitrum.properties``.

To refer to them:

::

  <img src={urlForPublic("../favicon.ico")} />

Serve resource files in classpath
---------------------------------

If you are a library developer and want to serve myimage.png from your library,
which is a .jar file in classpath:

Save the file in your .jar under ``public`` directory:

::

  public/my_lib/img/myimage.png

To refer to them in your source code:

::

  <img src={urlForResource("my_lib/img/myimage.png")} />

It will become:

::

  <img src="/resources/public/my_lib/img/myimage.png" />

Client side cache with ETag and max-age
---------------------------------------

Xitrum automatically adds `Etag <http://en.wikipedia.org/wiki/HTTP_ETag>`_ for
static files on disk and in classpath.

ETags for small files are MD5 of file content. They are and cached for later use.
Keys of cache entries are ``(file path, modified time)``. Each web server in a
cluster has its own local cache, because modified time on different servers may
differ.

For big files, modified time is used as ETag. This is not perfect because not
all requests can use the ETag when you have a cluster. But it is still better
than no ETag at all.

``urlForPublic`` and ``urlForResource`` automatically add ETag to the URLs they
generate. For example:

::

  urlForResource("xitrum/jquery-1.6.4.js")
  => /resources/public/xitrum/jquery-1.6.4.js?xndGJVH0zA8q8ZJJe1Dz9Q

Xitrum also sets ``max-age`` and ``Expires`` header to
`one year <http://code.google.com/intl/en/speed/page-speed/docs/caching.html>`_.
Don't worry that browsers do not pickup a latest file when you change it.
Because when a file on disk changes, its ``modified time`` changes, thus the URLs
generated by ``urlForPublic`` and ``urlForResource`` also change. Its ETag cache
is also invalidated because the cache key changes.

GZIP
----

Xitrum automatically gzips textual responses. It checks the ``Content-Type``
header to determine if a response is textual: ``text/html``, ``xml/application`` etc.

Xitrum always gzips static textual files, but for dynamic textual responses,
for overall performance reason it does not gzips response smaller than 1 KB.

Server side cache
-----------------

To avoid loading files from disk, Xitrum caches small static files
(not only textual) in memory with LRU (Least Recently Used) expiration.
See ``small_static_file_size_in_kb`` and ``max_cached_small_static_files``
in ``config/xitrum.properties``.
